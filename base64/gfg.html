<!DOCTYPE html>
<html>

<head>
    <title>Base64 Encode/Decode Image</title>
</head>

<body>
    <input type="file" id="fileId" onchange="imageUploaded()">
    <br><br>

    <button onclick="displayString()">Display Base64 String</button>
    <br><br>

    <img id="preview" style="max-width:300px; display:none;" />
    <br><br>

    <button id="download">Download Image File</button>

    <script>
        let base64String = "";
        let originalFile = null; // guardamos también el File original

        function imageUploaded() {
            originalFile = document.getElementById('fileId').files[0];
            if (!originalFile) return;

            const reader = new FileReader();

            reader.onload = function (e) {
                base64String = e.target.result; // dataURL completo
                console.log("Base64 cargado:", base64String.substring(0, 80) + "...");

                // Mostrar preview
                const img = document.getElementById("preview");
                img.src = base64String;
                img.style.display = "block";
            };

            reader.readAsDataURL(originalFile);
        }

        function displayString() {
            if (!base64String) {
                alert("Primero selecciona una imagen");
                return;
            }
            // ⚠️ Cuidado: mostrar todo con alert puede romper
            console.log(base64String);
            alert(base64String.substring(0, 200) + "...");
        }

        document.getElementById('download').addEventListener('click', () => {
            if (!originalFile) {
                alert("Primero selecciona una imagen");
                return;
            }
            // Usamos directamente el File original en lugar de reconstruir
            const url = URL.createObjectURL(originalFile);
            const link = document.createElement('a');
            link.href = url;
            link.download = originalFile.name || "imagen_descargada.png";
            link.click();
            URL.revokeObjectURL(url);
        });
    </script>
</body>

</html>